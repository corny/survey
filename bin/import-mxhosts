#!/usr/bin/env ruby
#
# Import results from dnsforward
#
require_relative '../config/environment'

i      = 0
result = {}

STDIN.each_line do |line|
  json      = JSON.parse(line)
  error     = json['error'].presence
  addresses = json['results']
  error     = "timeout" if error.try :end_with?, "timeout"

  if addresses
    addresses.each do |addr|
      # MxHost.find_or_create_by(hostname: json['domain'][0..-2], address: addr)
    end
  end

  i += 1
  puts "#{i} #{json['domain']}"

  if error
    status = error
  else
    status = addresses ? 'addresses' : 'empty'
  end

  result[status] ||= 0
  result[status]  += 1
end

puts result.to_yaml
